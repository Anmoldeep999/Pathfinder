<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Login - Project Pathfinder Dashboard</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <script src="assets/js/accessibility-init.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
<!-- Skip link to login form -->
<a href="#loginForm" class="skip-link">Skip to login form</a>

<main class="login-container" role="main">
  <h1 id="login-heading">Admin Login</h1>
  <p class="small" style="margin-bottom:24px;">Enter your credentials to access the dashboard</p>

  <form id="loginForm" style="display:grid;gap:16px;" aria-labelledby="login-heading">
    <div>
      <label for="username" style="display:block;margin-bottom:8px;font-weight:500;">Username</label>
      <input id="username" type="text" autocomplete="username" required placeholder="Enter username" aria-required="true"/>
    </div>

    <div>
      <label for="password" style="display:block;margin-bottom:8px;font-weight:500;">Password</label>
      <div class="password-wrapper">
        <input id="password" type="password" autocomplete="current-password" required placeholder="Enter password" aria-required="true"/>
        <button type="button" class="password-toggle" aria-label="Show password" data-target="password">
          <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
          <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
      </div>
    </div>

    <!-- reCAPTCHA widget -->
    <div class="g-recaptcha" data-sitekey="6Lfw9FksAAAAAMxTV17jlVCymlbsNb18HV59ViaG" data-theme="dark"></div>

    <button type="submit" class="btn" style="width:100%;margin-top:8px;" aria-label="Log in to dashboard">Log in</button>
    <button type="button" class="btn secondary" style="width:100%;" id="createAccountBtn" aria-label="Create a new account">Create Account</button>
    <p id="error" role="alert" aria-live="assertive" style="color:var(--bad);margin:0;display:none;font-size:0.875rem;text-align:center;"></p>
  </form>
  <a href="#" id="forgotPasswordBtn" class="small" style="display:block;text-align:center;margin-top:20px;color:var(--muted);text-decoration:underline;opacity:0.8;" aria-label="Request password reset via email">Forgot your password?</a>
</main>

<!-- Create Account Modal -->
<div id="createAccountModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-heading" style="display:none;">
  <div class="modal-content">
    <button type="button" class="modal-close" id="closeModalBtn" aria-label="Close create account modal">&times;</button>
    <h2 id="modal-heading">Create Account</h2>
    <p class="small" style="margin-bottom:20px;">Fill in your details to create a new account</p>
    
    <form id="createAccountForm" style="display:grid;gap:16px;">
      <div>
        <label for="registerFullName" style="display:block;margin-bottom:8px;font-weight:500;">Full Name</label>
        <input id="registerFullName" type="text" required placeholder="Enter your full name" aria-required="true"/>
      </div>
      
      <div>
        <label for="registerUsername" style="display:block;margin-bottom:8px;font-weight:500;">Username</label>
        <input id="registerUsername" type="text" autocomplete="username" required placeholder="Choose a username" aria-required="true"/>
      </div>
      
      <div>
        <label for="registerEmail" style="display:block;margin-bottom:8px;font-weight:500;">Email Address</label>
        <input id="registerEmail" type="email" autocomplete="email" required placeholder="Enter your email" aria-required="true"/>
      </div>
      
      <div>
        <label for="registerPassword" style="display:block;margin-bottom:8px;font-weight:500;">Password</label>
        <div class="password-wrapper">
          <input id="registerPassword" type="password" autocomplete="new-password" required placeholder="Create a password" aria-required="true" aria-describedby="passwordHelp"/>
          <button type="button" class="password-toggle" aria-label="Show password" data-target="registerPassword">
            <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
        <span id="passwordHelp" class="small" style="display:block;margin-top:4px;">Password must be at least 8 characters</span>
      </div>
      
      <div>
        <label for="registerConfirmPassword" style="display:block;margin-bottom:8px;font-weight:500;">Confirm Password</label>
        <div class="password-wrapper">
          <input id="registerConfirmPassword" type="password" autocomplete="new-password" required placeholder="Confirm your password" aria-required="true"/>
          <button type="button" class="password-toggle" aria-label="Show password" data-target="registerConfirmPassword">
            <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
            <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      
      <!-- reCAPTCHA widget -->
      <div class="g-recaptcha" data-sitekey="6Lfw9FksAAAAAMxTV17jlVCymlbsNb18HV59ViaG" data-theme="dark"></div>
      
      <button type="submit" class="btn" style="width:100%;margin-top:8px;" aria-label="Create your account">Create Account</button>
      <p id="registerError" role="alert" aria-live="assertive" style="color:var(--bad);margin:0;display:none;font-size:0.875rem;text-align:center;"></p>
      <p id="registerSuccess" role="status" aria-live="polite" style="color:var(--good);margin:0;display:none;font-size:0.875rem;text-align:center;"></p>
    </form>
  </div>
</div>

<!-- Live region for accessibility announcements -->
<div id="a11yAnnouncer" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>

<script src="assets/js/auth.js"></script>
<script src="assets/js/login.js"></script>
<script>
  // Password visibility toggle
  document.querySelectorAll('.password-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      const eyeOpen = this.querySelector('.eye-open');
      const eyeClosed = this.querySelector('.eye-closed');
      
      if (input.type === 'password') {
        input.type = 'text';
        eyeClosed.style.display = 'none';
        eyeOpen.style.display = 'block';
        this.setAttribute('aria-label', 'Hide password');
      } else {
        input.type = 'password';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
        this.setAttribute('aria-label', 'Show password');
      }
    });
  });

  document.getElementById("forgotPasswordBtn").addEventListener("click", function() {
    const username = document.getElementById("username").value.trim();
    if (!username) {
      const errorEl = document.getElementById("error");
      errorEl.textContent = "Please enter your username first";
      errorEl.style.display = "block";
      document.getElementById("username").focus();
      return;
    }
    
    const email = "info@projectpathfinder.be";
    const subject = encodeURIComponent("Pathfinder: Password change request");
    const body = encodeURIComponent(`Hello,

I would like to request a password reset for my Pathfinder account.

Username: ${username}

Thank you.`);
    
    window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  });

  // Create Account Modal functionality
  const modal = document.getElementById("createAccountModal");
  const createAccountBtn = document.getElementById("createAccountBtn");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const createAccountForm = document.getElementById("createAccountForm");
  const registerErrorEl = document.getElementById("registerError");
  const registerSuccessEl = document.getElementById("registerSuccess");

  // Open modal
  createAccountBtn.addEventListener("click", function() {
    modal.style.display = "flex";
    document.getElementById("registerFullName").focus();
    document.body.style.overflow = "hidden";
  });

  // Close modal
  function closeModal() {
    modal.style.display = "none";
    document.body.style.overflow = "";
    createAccountForm.reset();
    registerErrorEl.style.display = "none";
    registerSuccessEl.style.display = "none";
    if (typeof grecaptcha !== "undefined") {
      grecaptcha.reset();
    }
  }

  closeModalBtn.addEventListener("click", closeModal);

  // Close modal when clicking outside
  modal.addEventListener("click", function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape" && modal.style.display === "flex") {
      closeModal();
    }
  });

  // Handle account creation form submission
  createAccountForm.addEventListener("submit", async function(e) {
    e.preventDefault();
    registerErrorEl.style.display = "none";
    registerSuccessEl.style.display = "none";

    const fullName = document.getElementById("registerFullName").value.trim();
    const username = document.getElementById("registerUsername").value.trim();
    const email = document.getElementById("registerEmail").value.trim();
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("registerConfirmPassword").value;

    // Validate passwords match
    if (password !== confirmPassword) {
      registerErrorEl.textContent = "Passwords do not match";
      registerErrorEl.style.display = "block";
      document.getElementById("registerConfirmPassword").focus();
      return;
    }

    // Validate password length
    if (password.length < 8) {
      registerErrorEl.textContent = "Password must be at least 8 characters";
      registerErrorEl.style.display = "block";
      document.getElementById("registerPassword").focus();
      return;
    }

    // Verify reCAPTCHA
    const recaptchaResponse = grecaptcha.getResponse();
    if (!recaptchaResponse) {
      registerErrorEl.textContent = "Please complete the reCAPTCHA verification";
      registerErrorEl.style.display = "block";
      return;
    }

    const submitBtn = createAccountForm.querySelector("button[type=submit]");
    
    try {
      submitBtn.disabled = true;
      submitBtn.textContent = "Creating Account...";

      const res = await fetch(`${API_BASE}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          full_name: fullName,
          username: username,
          email: email,
          password: password,
          recaptcha_token: recaptchaResponse
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || "Registration failed");
      }

      registerSuccessEl.textContent = "Account created successfully! You can now log in.";
      registerSuccessEl.style.display = "block";
      createAccountForm.reset();
      grecaptcha.reset();

      // Close modal after 2 seconds
      setTimeout(closeModal, 2000);

    } catch (err) {
      registerErrorEl.textContent = err.message || "Failed to create account. Please try again.";
      registerErrorEl.style.display = "block";
      grecaptcha.reset();
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Create Account";
    }
  });
</script>

<script defer src="assets/js/animations.js"></script>
</body>
</html>
